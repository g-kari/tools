name: Auto Merge

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
  pull_request_review:
    types:
      - submitted
  check_suite:
    types:
      - completed
  workflow_run:
    workflows: ["E2E Tests"]
    types:
      - completed

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review' || github.event_name == 'check_suite' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write
      pull-requests: write
      checks: read

    steps:
      - name: Get PR number
        id: get_pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr_number;

            if (context.eventName === 'pull_request_target') {
              pr_number = context.payload.pull_request.number;
            } else if (context.eventName === 'pull_request_review') {
              pr_number = context.payload.pull_request.number;
            } else if (context.eventName === 'workflow_run') {
              const pulls = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
              });
              if (pulls.data.length > 0) {
                pr_number = pulls.data[0].number;
              }
            } else if (context.eventName === 'check_suite') {
              const pulls = context.payload.check_suite.pull_requests;
              if (pulls && pulls.length > 0) {
                pr_number = pulls[0].number;
              }
            }

            if (!pr_number) {
              console.log('No PR found, skipping');
              return '';
            }

            core.setOutput('pr_number', pr_number);
            return pr_number;

      - name: Check PR status and auto-merge
        if: steps.get_pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = ${{ steps.get_pr.outputs.pr_number }};

            try {
              // Get PR details
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number
              });

              console.log(`Checking PR #${pr_number}: ${pr.title}`);

              // Check if PR is already merged or closed
              if (pr.state !== 'open') {
                console.log(`PR is ${pr.state}, skipping`);
                return;
              }

              // Check if PR is draft
              if (pr.draft) {
                console.log('PR is draft, skipping');
                return;
              }

              // Check for unresolved conversations
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number
              });

              const blockingReviews = reviews.filter(review =>
                review.state === 'CHANGES_REQUESTED'
              );

              if (blockingReviews.length > 0) {
                console.log('PR has blocking reviews (changes requested), skipping');
                return;
              }

              // Check review comments for unresolved conversations
              const { data: reviewComments } = await github.rest.pulls.listReviewComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number
              });

              const unresolvedComments = reviewComments.filter(comment =>
                comment.in_reply_to_id === undefined &&
                comment.side === 'RIGHT'
              );

              // Get issue comments
              const { data: issueComments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number
              });

              console.log(`Found ${unresolvedComments.length} review comments and ${issueComments.length} issue comments`);

              // Check all status checks
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              const failedChecks = checks.check_runs.filter(check =>
                check.status === 'completed' && check.conclusion !== 'success' && check.conclusion !== 'skipped'
              );

              if (failedChecks.length > 0) {
                console.log(`PR has ${failedChecks.length} failed checks, skipping`);
                failedChecks.forEach(check => {
                  console.log(`  - ${check.name}: ${check.conclusion}`);
                });
                return;
              }

              // Check for in-progress checks
              const inProgressChecks = checks.check_runs.filter(check =>
                check.status !== 'completed'
              );

              if (inProgressChecks.length > 0) {
                console.log(`PR has ${inProgressChecks.length} checks still in progress, skipping`);
                return;
              }

              // Check commit statuses (for status API-based checks)
              const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              if (statuses.state === 'pending') {
                console.log('Some commit statuses are still pending, skipping');
                return;
              }

              if (statuses.state === 'failure') {
                console.log('Some commit statuses failed, skipping');
                return;
              }

              // All checks passed, merge the PR
              console.log('All conditions met, merging PR...');

              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
                merge_method: 'squash',
                commit_title: pr.title,
                commit_message: pr.body || ''
              });

              console.log('PR merged successfully!');

              // Delete the branch if it starts with 'claude/'
              if (pr.head.ref.startsWith('claude/')) {
                console.log(`Deleting branch ${pr.head.ref}...`);
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${pr.head.ref}`
                  });
                  console.log('Branch deleted successfully!');
                } catch (error) {
                  console.log(`Failed to delete branch: ${error.message}`);
                }
              }

            } catch (error) {
              console.error(`Error: ${error.message}`);
              // Don't fail the workflow if auto-merge fails
            }
